---
- name: Configurar RustDesk com senha fornecida
  hosts: windows
  vars:
    rustdesk_password: '{{ vault_rustdesk_password }}'  # Usando uma variável do Vault ou um placeholder

  tasks:
    - name: Criar um backup do arquivo de configuração do RustDesk para o usuário atual
      win_copy:
        remote_src: yes
        src: C:\Users\{{ ansible_user }}\AppData\Roaming\RustDesk\config\RustDesk2.toml
        dest: C:\Users\{{ ansible_user }}\AppData\Roaming\RustDesk\config\RustDesk2_backup.toml

    - name: Criar novo arquivo de configuração do RustDesk para o usuário atual
      win_template:
        src: rustdesk_config.j2
        dest: C:\Users\{{ ansible_user }}\AppData\Roaming\RustDesk\config\RustDesk2.toml

    - name: Reiniciar o serviço RustDesk
      win_service:
        name: Rustdesk
        state: restarted

    - name: Configurar a senha do RustDesk
      win_shell: |
        $password = '{{ rustdesk_password }}'
        # Comando para configurar a senha
        Start-Process -FilePath "C:\Program Files\RustDesk\RustDesk.exe" -ArgumentList "--password $password" -Wait
      args:
        executable: PowerShell
